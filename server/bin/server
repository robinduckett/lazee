#!/usr/bin/env coffee

dnode = require('dnode')
express = require('express')
http = require('http')
path = require('path')

d = dnode.connect(5001)

d.on 'remote', (remote) ->
    encoder = remote
    app = express()
    
    app.configure () ->
        app.set 'port', 4999
        app.set 'views', path.join(__dirname, '..', 'views')
        app.set 'view engine', 'ejs'
        app.set 'layout', 'layout'
        app.use require('express-partials')()
        app.use require 'express-blocks'
        app.use express.favicon(path.join(__dirname, '..', '..', 'client', 'images', 'favicon.ico'))
        app.use express.bodyParser()
        app.use express.cookieParser()
        app.use express.session(secret: 'test')
        app.use express.methodOverride()
        
        app.use (req, res, next) ->
            res.locals.session = req.session
            next()
            
        app.use app.router
        app.use express.static path.join(__dirname, '..', '..', 'client')
        app.use express.errorHandler()
        app.set 'encoder', encoder
        
    app.all "/api*", require("../lib/routes/api")
    app.all "/admin*", require("../lib/routes/admin")
    
    http.createServer(app).listen app.get('port'), () ->
      console.log("Express server listening on port " + app.get('port'))